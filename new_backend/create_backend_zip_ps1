# Create Backend ZIP for Azure Deployment
Write-Host "📦 Creating backend ZIP file..." -ForegroundColor Green

# Remove existing ZIP if it exists
if (Test-Path "backend.zip") {
    Remove-Item "backend.zip" -Force
    Write-Host "🗑️ Removed existing backend.zip" -ForegroundColor Yellow
}

# Create ZIP file with all necessary files
Write-Host "📁 Adding files to ZIP..." -ForegroundColor Yellow

# Add main application files
Compress-Archive -Path "app" -DestinationPath "backend.zip" -Force
Compress-Archive -Path "requirements.txt" -DestinationPath "backend.zip" -Update
Compress-Archive -Path "startup.sh" -DestinationPath "backend.zip" -Update
Compress-Archive -Path "gunicorn.conf.py" -DestinationPath "backend.zip" -Update
Compress-Archive -Path "web.config" -DestinationPath "backend.zip" -Update

# Add configuration files
if (Test-Path "configure_cors.py") {
    Compress-Archive -Path "configure_cors.py" -DestinationPath "backend.zip" -Update
}

# Add virtual environment (only necessary files)
if (Test-Path "venv\Lib\site-packages") {
    Write-Host "📦 Adding virtual environment packages..." -ForegroundColor Yellow
    Compress-Archive -Path "venv\Lib\site-packages" -DestinationPath "backend.zip" -Update
}

Write-Host "✅ Backend ZIP created successfully!" -ForegroundColor Green
Write-Host "📊 ZIP file size: $((Get-Item 'backend.zip').Length / 1MB) MB" -ForegroundColor Cyan

# List contents
Write-Host "📋 ZIP contents:" -ForegroundColor Yellow
Expand-Archive -Path "backend.zip" -DestinationPath "temp_check" -Force
Get-ChildItem -Path "temp_check" -Recurse | Select-Object FullName
Remove-Item "temp_check" -Recurse -Force
